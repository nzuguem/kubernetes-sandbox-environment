version: 3

includes:
  ingress:
    taskfile: ../ingress/tasks.yml
    dir: ../ingress

tasks:
  opentelemetry-install:
    desc: Install OTel Operator.
    deps:
      - ingress:nginx-install
    cmds:
      - helm repo add otel https://open-telemetry.github.io/opentelemetry-helm-charts
      - helm repo update otel
      - helm upgrade --install --version 0.60.0
        --create-namespace
        --namespace otel-system otel otel/opentelemetry-operator
        --set admissionWebhooks.certManager.enabled=false
        --set manager.collectorImage.repository=otel/opentelemetry-collector-contrib
  
  opentelemetry-uninstall:
    desc: Uninstall OTel Operator.
    cmd: helm del -n otel-system otel
  
  coroot-install:
    desc: Install Coroot Observability.
    deps:
      - ingress:nginx-install
    cmds:
      - helm repo add coroot https://coroot.github.io/helm-charts
      - helm repo update coroot
      - helm install --namespace coroot-system --create-namespace coroot coroot/coroot -f coroot/helm.values.yml
  
  coroot-uninstall:
    desc: Uninstall Coroot Observability.
    cmd: helm del -n coroot-system coroot
  
  prometheus-install:
    desc: Install Prometheus Operator.
    deps:
      - ingress:nginx-install
    cmds:
      - helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      - helm repo update prometheus-community
      - helm install prometheus-operator
        prometheus-community/kube-prometheus-stack
        --namespace monitoring
        --create-namespace
        -f observability/prometheus/helm.values.yml
      - task: grafana-get-credentials
  
  prometheus-uninstall:
    desc:  Uninstall Prometheus Operator.
    cmd: helm del -n monitoring prometheus-operator
  
  grafana-get-credentials:
    desc:  Uninstall Prometheus Operator.
    vars:
      GRAFANA_USER:
        sh: kubectl -n monitoring get secret prometheus-operator-grafana -o jsonpath="{.data.admin-user}" | base64 -d
      GRAFANA_PASSWORD:
        sh: kubectl -n monitoring get secret prometheus-operator-grafana -o jsonpath="{.data.admin-password}" | base64 -d
    cmd: 'echo "{{.GRAFANA_USER}}/{{.GRAFANA_PASSWORD}}"'