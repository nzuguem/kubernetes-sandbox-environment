version: 3 

tasks:
  argocd-install:
    desc: Install ArgoCD.
    silent: true
    cmds:
      - kubectl create namespace argocd || true
      - kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      # To expose the ArgoCD service in an Ingress/HTTPRoute, you will certainly need to disable TLS
      - |
        kubectl patch configmap argocd-cmd-params-cm -n argocd --type merge --patch '{"data": {"server.insecure": "true"}}'
      # Create Ingress Resources
      - kubectl apply -n argocd -f argocd/argocd.ingress.yml
      - kubectl wait -n argocd 
        --for=condition=ready pod
        --selector=app.kubernetes.io/name=argocd-repo-server
        --timeout=90s
  
  argocd-uninstall:
    desc: Uninstall ArgoCD.
    silent: true
    cmds:
      - kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      - kubectl delete -n argocd -f argocd/argocd.ingress.yml
      - kubectl delete ns/argocd
  
  argocd-get-credentials:
    desc: Get Credentials of ArgoCD.
    silent: true
    vars:
      ARGOCD_PASSWORD:
        sh: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
    cmds:
      - 'echo "admin/{{.ARGOCD_PASSWORD}}"'