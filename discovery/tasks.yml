version: 3

tasks:
  temporal-install:
    desc: Install Temporal IO.
    cmds:
      - helm repo add temporal https://go.temporal.io/helm-charts
      - helm repo update temporal
      - helm upgrade --install
        temporal temporal/temporal
        --timeout 15m
        --create-namespace
        --namespace temporal-system
        -f temporal/helm.values.yml
        --version 0.54.0
      - sleep 3
      - kubectl apply -f temporal/temporal.routes.yml -n temporal-system
      - task: temporal-configure-cli

  temporal-configure-cli:
    desc: Configure Temporal CLI
    cmd: |
      kubectl get secret temporal-gateway.127.0.0.1.nip.io-tls -n temporal-system -o jsonpath="{['data']['ca\.crt']}" | base64 --decode > /home/vscode/temporal-ing-ca.crt
      cat <<EOF >> /home/vscode/.bashrc
      export TEMPORAL_TLS_CA=/home/vscode/temporal-ing-ca.crt
      export TEMPORAL_ADDRESS=temporal-gateway.127.0.0.1.nip.io:443
      EOF
      source /home/vscode/.bashrc


  temporal-uninstall:
    desc: Uninstall Temporal IO.
    cmd: helm del -n temporal-system temporal

  microcks-install:
    desc: Install Microcks.
    cmds:
      - helm repo add microcks https://microcks.io/helm
      - helm repo update microcks
      - helm upgrade --install
        microcks microcks/microcks
        --create-namespace
        --namespace microcks
        -f microcks/helm.values.yml
        --version 1.10.1

  microcks-keycloak-get-credentials:
    desc: Get Credentials of Microcks Keycloak.
    vars:
      MICROCKS_KEYCLOAK_PASSWORD:
        sh: kubectl -n microcks get secret microcks-keycloak-admin -o jsonpath="{.data.password}" | base64 -d
    cmd: 'echo "admin/{{.MICROCKS_KEYCLOAK_PASSWORD}}"'

  microcks-uninstall:
    desc: Uninstall Microcks.
    cmd: helm del -n microcks microcks
